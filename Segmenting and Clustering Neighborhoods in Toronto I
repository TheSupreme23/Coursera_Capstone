# 1. PRIMERO IMPORTAMOS LAS LIBRERIAS

import requests 
import pandas as pd 
import numpy as np 
import random 

#INSTALAR GEOCODER
!conda install -c conda-forge geopy --yes 
from geopy.geocoders import Nominatim # module to convert an address into latitude and longitude values

# LIBRERIAS PARA DESPLEGAR IMAGENES
from IPython.display import Image 
from IPython.core.display import HTML 
    
# para tranformar archivo json en tablas PANDA
from pandas.io.json import json_normalize

#INSTALAR FOLIUM
!conda install -c conda-forge folium=0.5.0 --yes
import folium # plotting library

# LIBRERIA PARA WEB SCRAPING
from bs4 import BeautifulSoup

#VERIFICACION
print('Folium installed')
print('Libraries imported.')

# 2. WEB SCRAPING

# OBTENER html DE LA PAGINA DE wiki Y CREAR UN OBJETO "SOPA"
source = requests.get("https://en.wikipedia.org/wiki/List_of_postal_codes_of_Canada:_M")
soup = BeautifulSoup(source.text, 'lxml')

# USANDO EL OBJETO SOPA, SE INTERACTUA CON LA PAGINA Y SE SELECCIONA LA TABLA HTML QUE EST√Å DENTRO Y LO GUARDO EN UNA LISTA
data = []
columns = []
table = soup.find(class_='wikitable')
for index, tr in enumerate(table.find_all('tr')):
    section = []
    for td in tr.find_all(['th','td']):
        section.append(td.text.rstrip())
    
    #First row of data is the header
    if (index == 0):
        columns = section
    else:
        data.append(section)

#CONVIERTO LA LISTA EN UNA TABLA PANDA
canada_df = pd.DataFrame(data = data,columns = columns)
canada_df.head()

# 3. LIMPIEZA DE LA BASE 

#REMOVER LOS CASOS QUE TIENEN VALORES PERDIDO O NO ASIGNADOS
canada_df = canada_df[canada_df['Borough'] != 'Not assigned']
canada_df.head()

# ALGUNOS BARRIO TIENEN EL MISMO CODIGO DE AREA , VAMOS A AGRUPARLOS POR "neighborhoods" y SEPARARLOS POR UNA COMA
canada_df["Neighbourhood"] = canada_df.groupby("Postcode")["Neighbourhood"].transform(lambda neigh: ', '.join(neigh))

#REMOVIENDO DUPLICADOS
canada_df = canada_df.drop_duplicates()

#VERIFICACION
canada_df.head()

#SI LA CELDA TIENE "BOROUGH" PERO NO ESTA ASIGANADO UN neighborhood, AHORA LOS neighborhood SERAN LOS MISMOS QUE LOS borough
canada_df['Neighbourhood'].replace("Not assigned", canada_df["Borough"],inplace=True)
canada_df.head()

#DIMENSIONES DE LA TABLA
canada_df.shape
